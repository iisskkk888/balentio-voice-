# Balentio Voice - Техническое Задание

**Версия:** 2.0 (Финальная)
**Дата:** 2026-01-12
**Статус:** Готово к разработке
**Платформы:** macOS, Windows
**Референс:** [Aqua Voice](https://aquavoice.com/)

---

## 🎯 Краткое описание

Balentio Voice — коммерческий SaaS-продукт для голосовой транскрипции, созданный на основе форка open-source приложения Whispering.

**Ключевое отличие от Whispering**: Пользователь платит подписку и сразу работает — без API ключей, без выбора провайдеров, без технических знаний.

**Целевая аудитория**:
- Профессионалы (копирайтеры, журналисты, менеджеры)
- Студенты
- Обычные пользователи, которым нужна быстрая транскрипция

---

## 📊 Стратегическое позиционирование

### Whispering vs Balentio Voice

| Критерий | Whispering (open-source) | Balentio Voice (SaaS) |
|----------|--------------------------|----------------------|
| **Лицензия** | AGPL-3.0, открытый код | Проприетарный, коммерческий |
| **API ключи** | Пользователь приносит свои | Включены в подписку |
| **Провайдеры** | 7+ на выбор (OpenAI, Groq, ElevenLabs, etc) | Один бренд "Balentio" |
| **Настройки** | Сложные, для разработчиков | Простые, для всех |
| **Хранение данных** | 100% локально | Локально + облачный учёт использования |
| **Монетизация** | Бесплатно | Freemium ($0 / $10) |
| **Поддержка** | Сообщество | Официальная поддержка |

### Конкурентный анализ

| Компания | Цена | Бесплатный тариф | Модель |
|----------|------|------------------|--------|
| **Aqua Voice** | $8/мес | 1000 слов | Desktop приложение |
| **Otter.ai** | $16.99/мес | 300 минут/мес | Web + Mobile |
| **Balentio Voice** | **$10/мес** | **1500 слов** | **Desktop приложение** |

**Конкурентное преимущество**: Больше бесплатных слов чем у Aqua, дешевле чем Otter, приватнее чем оба.

---

## 💰 Ценообразование и бизнес-модель

### Тарифные планы

#### Бесплатный тариф
- **Цена**: $0
- **Лимит**: 1500 слов/месяц
- **Особенности**:
  - Полный функционал транскрипции
  - Локальная история записей
  - Горячие клавиши
  - Без водяных знаков
  - Без рекламы

**Назначение**: Канал привлечения, пробный период для конвертации в Pro

#### Pro тариф
- **Цена**: $10/месяц (годовая подписка)
- **Лимит**: Неограниченная транскрипция
- **Особенности**:
  - Всё из бесплатного тарифа
  - Неограниченная транскрипция
  - Приоритетная поддержка
  - Ранний доступ к новым функциям
  - (Будущее) Облачная синхронизация истории между устройствами

### Экономика продукта

**Средний пользователь**: 10 часов транскрипции в месяц = 90,000 слов

```
Расчёт прибыли (Pro пользователь):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Доход:                $10.00/месяц
Стоимость ElevenLabs: $4.00 (10 часов × $0.40)
Комиссия Stripe:      $0.59 (2.9% + $0.30)
Инфраструктура:       $0.50 (Supabase, Railway, CDN)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Чистая прибыль:       $4.91/месяц (49% маржа)

Цель: 200 Pro пользователей = $982/месяц прибыли
```

**Стоимость бесплатного тарифа**: 1500 слов = ~0.17 часа = $0.07 на пользователя

---

## 🏗️ Техническая архитектура

### Общая архитектура

```
┌─────────────────────────────────────────────────────────┐
│                  С ТОЧКИ ЗРЕНИЯ ПОЛЬЗОВАТЕЛЯ            │
│   "Я плачу $10/мес и просто диктую в любом приложении"  │
└─────────────────────────────────────────────────────────┘
                          │
                          │ Нажимает горячую клавишу
                          ▼
            ┌─────────────────────────────┐
            │   Balentio Voice Desktop    │
            │   (Tauri 2 + Svelte 5)      │
            │                             │
            │   • macOS (Intel + ARM)     │
            │   • Windows 10/11           │
            │                             │
            │   Хранит локально:          │
            │   • История транскрипций    │
            │   • JWT токены (безопасно)  │
            │   • Настройки пользователя  │
            └─────────────────────────────┘
                          │
                          │ HTTPS API запросы
                          │ Authorization: Bearer <JWT>
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  BACKEND BALENTIO                       │
│              (Hono + PostgreSQL)                        │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Middleware аутентификации                       │  │
│  │  • Проверка JWT токена                           │  │
│  │  • Проверка статуса подписки                     │  │
│  │  • Ограничение запросов                          │  │
│  └──────────────────────────────────────────────────┘  │
│                          │                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Бизнес-логика                                   │  │
│  │  • Проверка месячного лимита слов < 1500 (free)  │  │
│  │  • Отправка аудио в ElevenLabs                   │  │
│  │  • Подсчёт слов в результате                     │  │
│  │  • Логирование использования в БД                │  │
│  │  • Возврат транскрибированного текста            │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  База данных (PostgreSQL):                              │
│  • users (пользователи)                                 │
│  • subscriptions (подписки)                             │
│  • usage_logs (только количество слов, НЕ текст!)       │
│                                                         │
└─────────────────────────────────────────────────────────┘
                          │
                          │ НАШ API ключ ElevenLabs
                          ▼
            ┌─────────────────────────────┐
            │      ElevenLabs API         │
            │   Модель Scribe v1          │
            │   $0.40 за час              │
            └─────────────────────────────┘
```

### Паттерн Backend Proxy

**Пользователь НЕ знает про ElevenLabs**. Для него это "транскрипция Balentio Voice".

**Преимущества**:
1. Контроль качества (мы выбираем лучшую модель)
2. Прозрачная монетизация (пользователь платит нам, не ElevenLabs)
3. Гибкость (можем сменить провайдера без изменений в desktop приложении)
4. Учёт использования (знаем реальное использование)

---

## 🔐 Аутентификация и безопасность

### Стратегия JWT токенов

**Проблема**: Desktop приложение должно помнить, что пользователь залогинен.

**Решение**: Два токена — Access Token (короткий) и Refresh Token (длинный).

#### Жизненный цикл токенов

```
Вход пользователя
   │
   ├─► Backend возвращает:
   │   • access_token (истекает через 15 минут)
   │   • refresh_token (истекает через 30 дней)
   │
   ├─► Desktop приложение сохраняет токены в:
   │   • macOS: Keychain (зашифровано)
   │   • Windows: Credential Manager (зашифровано)
   │
   ├─► Каждый API запрос:
   │   POST /api/transcribe
   │   Headers: { Authorization: "Bearer <access_token>" }
   │
   ├─► Access token истекает через 15 мин:
   │   • Приложение автоматически обновляет с помощью refresh_token
   │   • Получает новую пару токенов
   │   • Пользователь ничего не замечает
   │
   └─► Refresh token истекает через 30 дней:
       • Пользователь должен войти снова
```

**Преимущества безопасности**:
- Короткоживущие access токены минимизируют ущерб при краже
- Долгоживущие refresh токены обеспечивают удобство
- Токены хранятся зашифровано (безопасность на уровне ОС)
- Пароли не хранятся на устройстве

### Приватность данных

**Что мы храним в облаке**:
- ✅ Email пользователя
- ✅ Статус подписки
- ✅ Использование по количеству слов (только цифры)
- ✅ Временные метки

**Что мы НЕ храним**:
- ❌ Текст транскрипций
- ❌ Аудиофайлы
- ❌ Детали активности пользователя

**Соответствие**: GDPR, CCPA

---

## 🛠️ Технологический стек

### Frontend (Desktop приложение)

| Технология | Назначение | Версия |
|-----------|-----------|--------|
| **Tauri 2** | Кроссплатформенный фреймворк (Rust) | 2.x |
| **Svelte 5** | UI фреймворк с реактивными рунами | 5.x |
| **TypeScript** | Типобезопасный JavaScript | 5.9+ |
| **Bun** | Менеджер пакетов и сборщик | 1.3+ |
| **Vite** | Инструмент сборки | 7.x |
| **shadcn-svelte** | UI компоненты | Последняя |
| **Tailwind CSS 4** | Стилизация | 4.x |
| **TanStack Query** | Управление состоянием и кэширование | 6.x |
| **Dexie.js** | Обёртка для IndexedDB (локальная история) | 4.x |
| **Web Audio API** | Запись и визуализация аудио | Встроенная |

### Backend (API сервер)

| Технология | Назначение | Версия |
|-----------|-----------|--------|
| **Hono** | Web-фреймворк (быстрый, легковесный) | 4.x |
| **Node.js** | Runtime | 20+ LTS |
| **TypeScript** | Типобезопасность | 5.9+ |
| **PostgreSQL** | Реляционная база данных | 15+ |
| **Drizzle ORM** | Типобезопасные запросы к БД | 0.44+ |
| **Supabase** | Auth + хостинг БД | Последняя |
| **ElevenLabs SDK** | Провайдер транскрипции | 1.x |
| **Stripe SDK** | Обработка платежей | Последняя |
| **arktype** | Валидация во время выполнения | 2.x |

### Инфраструктура и хостинг

| Сервис | Назначение | План |
|---------|---------|------|
| **Railway** | Хостинг backend API | Hobby → Pro |
| **Supabase** | PostgreSQL + Auth | Free → Pro |
| **Stripe** | Подписочный биллинг | 2.9% + $0.30 |
| **ElevenLabs** | API транскрипции | Pay-as-you-go |
| **Cloudflare** | CDN + защита от DDoS | Бесплатно |
| **GitHub** | Репозиторий кода | Приватный репо |
| **GitHub Actions** | CI/CD для сборок | Бесплатно |

---

## 🏗️ Общая структура монорепо

```
balentio-voice-/
│
├── apps/
│   │
│   ├── api/                                    # 🆕 НОВЫЙ - Backend API
│   │   ├── src/
│   │   │   ├── index.ts                        # Точка входа Hono app
│   │   │   ├── env.ts                          # Валидация env переменных
│   │   │   │
│   │   │   ├── db/
│   │   │   │   ├── index.ts                    # Drizzle client
│   │   │   │   ├── schema.ts                   # Database схемы
│   │   │   │   └── migrate.ts                  # Миграции
│   │   │   │
│   │   │   ├── middleware/
│   │   │   │   ├── auth.ts                     # JWT verification
│   │   │   │   ├── rate-limit.ts               # Rate limiting
│   │   │   │   └── cors.ts                     # CORS config
│   │   │   │
│   │   │   ├── routes/
│   │   │   │   ├── index.ts                    # Routes aggregator
│   │   │   │   ├── health.ts                   # GET /health
│   │   │   │   ├── auth/
│   │   │   │   │   └── refresh.ts              # POST /auth/refresh
│   │   │   │   ├── transcribe/
│   │   │   │   │   └── index.ts                # POST /transcribe
│   │   │   │   ├── usage/
│   │   │   │   │   └── index.ts                # GET /usage/current-month
│   │   │   │   ├── subscription/
│   │   │   │   │   └── index.ts                # GET /subscription
│   │   │   │   ├── stripe/
│   │   │   │   │   └── create-checkout.ts      # POST /stripe/create-checkout
│   │   │   │   └── webhooks/
│   │   │   │       └── stripe.ts               # POST /webhooks/stripe
│   │   │   │
│   │   │   ├── services/
│   │   │   │   ├── elevenlabs.ts               # ElevenLabs интеграция
│   │   │   │   ├── stripe.ts                   # Stripe SDK
│   │   │   │   ├── usage-tracker.ts            # Подсчёт использования
│   │   │   │   └── word-counter.ts             # Подсчёт слов
│   │   │   │
│   │   │   └── lib/
│   │   │       ├── jwt.ts                      # JWT helpers
│   │   │       └── logger.ts                   # Logging
│   │   │
│   │   ├── drizzle/                            # SQL миграции
│   │   ├── package.json
│   │   ├── tsconfig.json
│   │   └── drizzle.config.ts
│   │
│   └── whispering/                             # ♻️ МОДИФИЦИРУЕМ - Desktop App
│       ├── src/
│       │   ├── lib/
│       │   │   ├── services/
│       │   │   │   ├── auth/                   # 🆕 НОВЫЙ
│       │   │   │   │   ├── index.ts
│       │   │   │   │   ├── supabase.ts         # Supabase client
│       │   │   │   │   └── token-manager.ts    # JWT хранение (Tauri store)
│       │   │   │   │
│       │   │   │   ├── api/                    # 🆕 НОВЫЙ
│       │   │   │   │   ├── client.ts           # API client с JWT
│       │   │   │   │   └── endpoints.ts        # Type-safe endpoints
│       │   │   │   │
│       │   │   │   ├── subscription/           # 🆕 НОВЫЙ
│       │   │   │   │   ├── index.ts
│       │   │   │   │   └── stripe-checkout.ts  # Stripe checkout
│       │   │   │   │
│       │   │   │   ├── transcription/
│       │   │   │   │   ├── cloud/
│       │   │   │   │   │   ├── balentio.ts    # 🆕 НОВЫЙ - наш провайдер
│       │   │   │   │   │   ├── elevenlabs.ts  # ❌ УДАЛИТЬ
│       │   │   │   │   │   ├── openai.ts      # ❌ УДАЛИТЬ
│       │   │   │   │   │   ├── groq.ts        # ❌ УДАЛИТЬ
│       │   │   │   │   │   ├── deepgram.ts    # ❌ УДАЛИТЬ
│       │   │   │   │   │   └── mistral.ts     # ❌ УДАЛИТЬ
│       │   │   │   │   │
│       │   │   │   │   └── registry.ts        # ♻️ МОДИФИЦИРОВАТЬ - только Balentio
│       │   │   │   │
│       │   │   │   ├── db/
│       │   │   │   │   ├── index.ts           # Dexie instance
│       │   │   │   │   └── recordings.ts      # 🆕 НОВЫЙ - История записей
│       │   │   │   │
│       │   │   │   └── recorder/              # ✅ БЕЗ ИЗМЕНЕНИЙ
│       │   │   │
│       │   │   ├── stores/                    # Svelte state
│       │   │   │   ├── auth.svelte.ts         # 🆕 НОВЫЙ - Auth state
│       │   │   │   ├── subscription.svelte.ts # 🆕 НОВЫЙ - Subscription state
│       │   │   │   ├── usage.svelte.ts        # 🆕 НОВЫЙ - Usage counter
│       │   │   │   └── settings.svelte.ts     # ♻️ МОДИФИЦИРОВАТЬ
│       │   │   │
│       │   │   └── settings/
│       │   │       └── settings.ts            # ♻️ МОДИФИЦИРОВАТЬ - удалить apiKeys
│       │   │
│       │   ├── routes/
│       │   │   ├── (auth)/                    # 🆕 НОВАЯ ГРУППА
│       │   │   │   ├── +layout.svelte
│       │   │   │   ├── login/
│       │   │   │   │   └── +page.svelte
│       │   │   │   └── register/
│       │   │   │       └── +page.svelte
│       │   │   │
│       │   │   ├── (app)/
│       │   │   │   ├── +layout.svelte         # ♻️ ADD auth guard
│       │   │   │   ├── +page.svelte           # ♻️ ADD usage counter
│       │   │   │   │
│       │   │   │   └── (config)/
│       │   │   │       ├── account/           # 🆕 НОВАЯ СТРАНИЦА
│       │   │   │       │   └── +page.svelte
│       │   │   │       │
│       │   │   │       ├── pricing/           # 🆕 НОВАЯ СТРАНИЦА
│       │   │   │       │   └── +page.svelte
│       │   │   │       │
│       │   │   │       ├── history/           # 🆕 НОВАЯ СТРАНИЦА
│       │   │   │       │   └── +page.svelte
│       │   │   │       │
│       │   │   │       └── settings/
│       │   │   │           ├── api-keys/      # ❌ УДАЛИТЬ
│       │   │   │           └── transcription/
│       │   │   │               └── +page.svelte # ♻️ УПРОСТИТЬ
│       │   │   │
│       │   │   └── overlay/                   # 🆕 НОВАЯ СТРАНИЦА
│       │   │       └── +page.svelte           # Recording overlay
│       │   │
│       │   └── components/                    # 🆕 НОВАЯ ПАПКА
│       │       ├── auth/
│       │       │   ├── LoginForm.svelte
│       │       │   └── RegisterForm.svelte
│       │       │
│       │       ├── subscription/
│       │       │   ├── UsageCounter.svelte
│       │       │   ├── PricingCard.svelte
│       │       │   └── UpgradePrompt.svelte
│       │       │
│       │       ├── history/
│       │       │   ├── RecordingCard.svelte
│       │       │   └── RecordingList.svelte
│       │       │
│       │       └── overlay/
│       │           ├── Waveform.svelte        # Audio визуализация
│       │           └── RecordingTimer.svelte
│       │
│       ├── src-tauri/
│       │   ├── tauri.conf.json               # ♻️ МОДИФИЦИРОВАТЬ - identifier
│       │   └── Cargo.toml                    # ♻️ МОДИФИЦИРОВАТЬ - name
│       │
│       └── package.json                       # ♻️ МОДИФИЦИРОВАТЬ - name, добавить @supabase
│
└── packages/
    └── db/                                    # 🆕 НОВЫЙ PACKAGE
        ├── src/
        │   ├── index.ts
        │   ├── schema/
        │   │   ├── index.ts
        │   │   ├── users.ts                   # Users table
        │   │   ├── subscriptions.ts           # Subscriptions table
        │   │   └── usage-logs.ts              # Usage logs table
        │   │
        │   └── client.ts                      # Drizzle client
        │
        ├── drizzle/
        │   └── migrations/
        │       └── 0000_initial.sql
        │
        ├── package.json
        └── drizzle.config.ts
```

### Оверлей записи

**Дизайн**: Минималистичное плавающее окно поверх всех приложений

```
┌──────────────────────────────────────────┐
│  🎙️ Запись...                    [00:23] │
├──────────────────────────────────────────┤
│                                          │
│     ~~~  ~~~~  ~~~  ~~~~  ~~~  ~~~~     │ ← Анимированная волна
│    ~~~  ~~~~  ~~~  ~~~~  ~~~  ~~~~      │
│                                          │
│           [Стоп]    [Отмена]             │
│                                          │
└──────────────────────────────────────────┘
```

**Состояния окна**:

1. **Запись**: Живая визуализация волны + таймер
2. **Обработка**: Прогресс-бар "Транскрибирую..."
3. **Завершено**: Автоматически закрывается, текст копируется в буфер обмена

**Технология визуализации**: Web Audio API `AnalyserNode` для данных частот в реальном времени

### История транскрипций

**Расположение**: Главное окно приложения → Вкладка История

**Интерфейс**:
```
┌─────────────────────────────────────────────────┐
│  📝 История                      [Очистить всё] │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │ Сегодня, 2:45 PM              87 слов    │  │
│  │ "Привет, это тест..."                    │  │
│  │ [Копировать]  [Удалить]  [Показать всё]  │  │
│  └──────────────────────────────────────────┘  │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │ Сегодня, 10:23 AM             234 слова  │  │
│  │ "Заметки встречи: Обсудили..."           │  │
│  │ [Копировать]  [Удалить]  [Показать всё]  │  │
│  └──────────────────────────────────────────┘  │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │ Вчера, 4:15 PM                156 слов   │  │
│  │ "Напоминание купить продукты..."         │  │
│  │ [Копировать]  [Удалить]  [Показать всё]  │  │
│  └──────────────────────────────────────────┘  │
│                                                 │
└─────────────────────────────────────────────────┘
```

**Хранение**: Локально в IndexedDB (как у Aqua Voice)

**Функции**:
- Просмотр всех записей (в обратном хронологическом порядке)
- Копирование текста в буфер обмена
- Удаление записи
- Просмотр полного текста (модальное окно)
- Группировка по дням ("Сегодня", "Вчера", "На этой неделе", "Старше")

**Лимиты хранения**:
- Последние 500 записей
- Или последние 90 дней
- Что наступит раньше

### Панель аккаунта и использования

```
┌─────────────────────────────────────────────────┐
│  Аккаунт                                        │
├─────────────────────────────────────────────────┤
│                                                 │
│  👤 john@example.com                            │
│     Присоединился в декабре 2025                │
│                                                 │
│  📊 Использование в этом месяце:                │
│                                                 │
│  Бесплатный план: 1,247 / 1,500 слов           │
│  [████████████░░░] 83%                          │
│                                                 │
│  Осталось только 253 слова                      │
│                                                 │
│  [Обновить до Pro - $10/месяц]                  │
│                                                 │
│  Неограниченная транскрипция                    │
│  Приоритетная поддержка                         │
│  Ранний доступ к новым функциям                 │
│                                                 │
├─────────────────────────────────────────────────┤
│  [Изменить пароль]  [Выйти]                     │
└─────────────────────────────────────────────────┘
```

## 📱 Основные функции

### 1. Голосовая запись

**Методы активации**:
- Настраиваемая горячая клавиша (по умолчанию: Cmd+Shift+Space на macOS, Ctrl+Shift+Space на Windows)
- Клик по иконке в строке меню
- Клик по иконке в системном трее

**Режимы записи** (сохранены из Whispering):
- **Ручной**: Пользователь контролирует старт/стоп
- **VAD (Voice Activity Detection)**: Автостоп после тишины
- **Загрузка файла**: Перетаскивание аудио/видео файлов

**Поддерживаемые форматы**:
- Аудио: MP3, WAV, M4A, OGG, FLAC
- Видео: MP4, MOV, AVI, MKV (извлечение аудио)

### 2. Системная интеграция

**Вставка в активное окно**:
- После транскрипции текст автоматически вставляется в активное приложение
- Работает в: Chrome, VS Code, Slack, Notion, Gmail и др.
- Опциональное нажатие Enter после вставки

**Интеграция с буфером обмена**:
- Текст копируется в системный буфер обмена
- Можно отключить в настройках

### 3. Умная транскрипция

**Возможности ElevenLabs Scribe v1**:
- 96.7% точность для английского языка
- Поддержка 99 языков
- Автоматическая пунктуация
- Капитализация имён и мест
- Временные метки на уровне слов (для будущих функций)

**Настройка**:
- **Промпт/Контекст**: Пользователь может добавить контекст ("Это медицинская консультация...")
- **Температура**: Контроль креативности модели (0.0 = детерминированный, 1.0 = креативный)
- **Язык вывода**: Принудительный язык вывода

### 4. Отслеживание использования

**Счётчик в реальном времени**:
- Показывается в главном окне
- Обновляется после каждой транскрипции
- Визуальный индикатор приближения к лимиту

**Применение лимитов**:
```
Перед началом записи:
→ Проверить текущее месячное количество слов
→ Если >= 1500 слов (бесплатный тариф):
  ✋ Заблокировать запись
  💬 Показать предложение об обновлении
→ Если < 1500 слов:
  ✅ Разрешить запись
```

**Уведомления**:
- 80% использования: "Вы использовали 1200 / 1500 слов"
- 90% использования: "Осталось только 150 слов"
- 100% использования: "Достигнут лимит бесплатного тарифа. Обновиться до Pro?"

---

## 🔄 Пользовательские сценарии

### Путь нового пользователя

```
1. Скачать и установить
   ↓
2. Открыть приложение → Экран приветствия
   ↓
3. Зарегистрироваться / Войти
   ↓
4. Дать разрешения на микрофон
   ↓
5. Быстрое обучение (анимированное):
   "Нажмите Cmd+Shift+Space чтобы начать запись"
   ↓
6. Первая транскрипция (с подсказками)
   ↓
7. Увидеть результат + счётчик использования
   "У вас осталось 1,487 / 1,500 бесплатных слов"
```

### Ежедневное использование (вернувшийся пользователь)

```
1. Приложение работает в фоне
   ↓
2. Нажать горячую клавишу где угодно
   ↓
3. Появляется оверлей → Начать говорить
   ↓
4. Нажать горячую клавишу снова для остановки (или автостоп с VAD)
   ↓
5. Оверлей показывает "Транскрибирую..."
   ↓
6. Текст вставляется в активное окно + копируется в буфер обмена
   ↓
7. Оверлей автоматически закрывается
   ↓
8. История сохранена локально
```

### Сценарий обновления

```
1. Пользователь достигает 1500 слов
   ↓
2. Пытается записать → Заблокирован
   ↓
3. Модальное окно: "Достигнут лимит бесплатного тарифа"
   [Обновить до Pro] [Не сейчас]
   ↓
4. Клик Обновить → Страница тарифов
   ↓
5. Выбрать Pro → Stripe Checkout
   ↓
6. Завершить оплату
   ↓
7. Перенаправление обратно в приложение
   ↓
8. Подписка активирована немедленно
   ↓
9. Может записывать снова (неограниченно)
```

---

## 🚀 Дорожная карта разработки

### Фаза 1: Основа (Недели 1-2)

**Настройка Backend**:
- Создать структуру папки `apps/api`
- Настроить Hono сервер с TypeScript
- Настроить Drizzle ORM + подключение PostgreSQL
- Создать схему БД + миграции
- Развернуть на Railway (staging)

**Инфраструктура**:
- Настроить проект Supabase
- Настроить Supabase Auth (email/пароль)
- Создать политики RLS
- Настроить переменные окружения
- Настроить CORS

**Результаты**:
- Работающий backend API (эндпоинт проверки здоровья)
- База данных с таблицами
- Функционирующий Supabase Auth

---

### Фаза 2: Основное API (Недели 2-3)

**Аутентификация**:
- Middleware проверки JWT
- Эндпоинт обновления токена
- Middleware ограничения запросов
- Обработка ошибок аутентификации

**Эндпоинт транскрипции**:
- Эндпоинт POST /api/transcribe
- Интеграция API ElevenLabs
- Обработка загрузки аудиофайлов
- Логика подсчёта слов
- Логирование использования

**Логика подписки**:
- Проверка статуса подписки
- Проверка месячного количества слов
- Применение лимита бесплатного тарифа (1500 слов)
- Возврат данных об использовании в ответах

**Результаты**:
- Функционирующий эндпоинт /api/transcribe
- Работающее отслеживание использования
- Применение лимитов бесплатного тарифа

---

### Фаза 3: Интеграция Stripe (Недели 3-4)

**Настройка Stripe**:
- Создать аккаунт Stripe
- Создать продукты (Бесплатный вручную, Pro $10/месяц)
- Настроить эндпоинт webhook
- Тестировать с Stripe CLI

**Процесс оформления заказа**:
- Эндпоинт POST /api/stripe/create-checkout
- Обработка URL успеха/отмены
- Создание клиента в Stripe
- Связь клиента Stripe с нашей таблицей users

**Обработчик Webhook**:
- Эндпоинт POST /api/webhooks/stripe
- Обработка checkout.session.completed
- Обработка customer.subscription.updated
- Обработка customer.subscription.deleted
- Обработка invoice.payment_failed
- Соответствующее обновление БД

**Результаты**:
- Работающий процесс оформления заказа
- Корректная обработка webhooks
- Синхронизация статуса подписки

---

### Фаза 4: Desktop приложение - Аутентификация (Недели 4-5)

**Сервис аутентификации**:
- Интеграция клиента Supabase
- Хранение токенов (Tauri secure storage)
- Логика автообновления токена
- Функционал выхода

**UI аутентификации**:
- Страница входа
- Страница регистрации
- Процесс сброса пароля
- Layout аутентификации с guards

**Управление состоянием**:
- Хранилище аутентификации (Svelte runes)
- Состояние информации о пользователе
- Состояние статуса подписки
- Состояние счётчика использования

**Результаты**:
- Пользователи могут регистрироваться и входить
- Токены хранятся безопасно
- Аутентификация сохраняется при перезапуске приложения

---

### Фаза 5: Desktop приложение - Транскрипция (Недели 5-6)

**Провайдер Balentio**:
- Создать новый провайдер транскрипции
- API клиент с JWT аутентификацией
- Загрузка аудио FormData
- Обработка ошибок (истекшая подписка, достигнут лимит)
- Парсинг успешного ответа

**Обновления реестра**:
- Удалить все другие провайдеры
- Установить Balentio как единственный провайдер
- Удалить поля ввода API ключей из UI
- Упростить выбор провайдера

**Интеграция процесса записи**:
- Проверка использования перед разрешением записи
- Показ предупреждений о лимите
- Блокировка записи при достижении лимита
- Обновление счётчика использования после транскрипции

**Результаты**:
- Транскрипция работает через backend
- Применение лимитов использования
- Плавный пользовательский опыт

---

### Фаза 6: Доработка UI/UX (Недели 6-7)

**Ребрендинг**:
- Замена "Whispering" → "Balentio Voice"
- Обновление идентификаторов приложения
- Новый логотип и иконки
- Обновление цветовой схемы
- Обновление всех текстов

**Оверлей записи**:
- Создать плавающее окно
- Визуализация волны (Web Audio API)
- Таймер записи
- Кнопки Стоп/Отмена
- Состояние обработки
- Автозакрытие при завершении

**UI истории**:
- Вкладка истории в главном окне
- Список записей (обратный хронологический порядок)
- Действия Копировать/Удалить
- Модальное окно просмотра полного текста
- Локальное хранилище (IndexedDB)
- Группировка по дням

**Страницы аккаунта**:
- Страница Аккаунт/Профиль
- Панель использования с прогресс-баром
- Страница тарифов
- Кнопка обновления
- Управление подпиской

**Очистка настроек**:
- Удалить раздел API ключей
- Удалить выбор провайдера
- Упростить настройки транскрипции
- Сохранить конфигурацию горячих клавиш
- Сохранить настройки VAD

**Результаты**:
- Отполированный, брендированный UI
- Красивый оверлей
- Функциональная история
- Полное управление аккаунтом

---

### Фаза 7: Тестирование и запуск (Недели 7-8)

**Внутреннее тестирование**:
- Функциональное тестирование (все функции)
- Тестирование процесса оплаты (тестовый режим Stripe)
- Граничные случаи (достигнут лимит, истекшая подписка)
- Кроссплатформенное тестирование (macOS Intel, macOS ARM, Windows)
- Тестирование производительности

**Бета-тестирование**:
- Пригласить 5-10 бета-пользователей
- Предоставить тестовые Pro подписки
- Собрать структурированную обратную связь
- Отслеживать логи ошибок
- Отслеживать паттерны использования

**Исправление ошибок и оптимизация**:
- Исправить критические ошибки
- Оптимизировать медленные эндпоинты
- Улучшить сообщения об ошибках
- Отполировать анимации
- Уменьшить размер приложения

**Продакшн-деплой**:
- Развернуть backend на Railway (продакшн)
- Настроить продакшн-БД
- Включить live режим Stripe
- Настроить мониторинг (логи Railway)
- Настроить отслеживание ошибок (опционально: Sentry)

**Подпись и распространение приложения**:
- Сертификаты подписи кода (macOS, Windows)
- Нотаризация сборок macOS
- Подпись сборок Windows
- Создать установщики (.dmg, .exe)
- Тестировать автообновление

**Мягкий запуск**:
- Запуск для бета-пользователей
- Создать лендинг (простая одностраничка)
- Анонс в социальных сетях
- Публикация на Product Hunt (опционально)

**Результаты**:
- Готовое к продакшну приложение
- Подписанные установщики для macOS и Windows
- Backend развёрнут и мониторится
- 5-10 платящих бета-пользователей

---

## 📊 Метрики успеха (MVP)

### Технические метрики

- **Успешность транскрипции**: > 98%
- **Средняя задержка транскрипции**: < 3 секунд
- **Uptime backend**: > 99.5%
- **Частота падений приложения**: < 0.1%

### Бизнес-метрики

- **Бета-пользователи**: 10-20 активных пользователей
- **Конверсия Free → Pro**: > 20%
- **Месячно активные пользователи (MAU)**: > 50 за 3 месяца
- **Показатель оттока**: < 10%
- **Средняя длина транскрипции**: 100-200 слов
- **Месячный доход**: $100+ (минимум 10 Pro пользователей)

### Метрики пользовательского опыта

- **Средняя длина сессии**: > 5 транскрипций/день
- **Удержание пользователей (День 7)**: > 40%
- **Удержание пользователей (День 30)**: > 25%
- **Net Promoter Score (NPS)**: > 30

---

## 🎯 Объём MVP (Что входит, что не входит)

### ✅ Входит в MVP

**Обязательно**:
- Аутентификация email/пароль
- Транскрипция через backend (ElevenLabs)
- Бесплатный тариф 1500 слов
- Pro тариф $10/месяц (неограниченно)
- Отслеживание и применение использования
- Локальная история (IndexedDB)
- Оверлей записи с волной
- Вставка во всю систему
- Конфигурация горячих клавиш
- Базовые настройки
- Интеграция оформления заказа Stripe
- Сборки для macOS и Windows

**Хорошо бы иметь (если будет время)**:
- Режим VAD
- Загрузка файлов
- Пользовательские промпты
- Слайдер температуры

---

### ❌ Не входит в MVP

**Функции после MVP**:
- Социальная аутентификация (Google, GitHub)
- Облачная синхронизация истории
- Мобильные приложения
- Командные тарифы
- Лендинг (полный маркетинговый сайт)
- Email уведомления
- Пользовательские инструкции для каждого приложения
- Голосовые команды
- Поддержка Linux
- API для разработчиков
- Webhooks
- Диаризация спикеров
- Потоковая транскрипция в реальном времени
- Обучение пользовательских моделей

---

## 🔒 Безопасность и соответствие

### Защита данных

**Шифрование**:
- Всё API общение через HTTPS (TLS 1.3)
- JWT токены подписаны с помощью RS256
- Refresh токены хранятся зашифрованными (уровень ОС)
- Подключения к БД зашифрованы

**Приватность**:
- Текст транскрипций не хранится на серверах
- Логируются только количества слов для биллинга
- Аудиофайлы не хранятся
- Нет трекинга/аналитики (опционально PostHog после MVP)

**Соответствие**:
- Соответствие GDPR (пользователи ЕС могут удалить аккаунт + все данные)
- Соответствие CCPA (пользователи Калифорнии имеют права на данные)
- Stripe соответствует PCI DSS (мы не обрабатываем данные карт)

### Ограничение запросов

**Лимиты на пользователя**:
- 20 транскрипций в час (бесплатный тариф)
- 100 транскрипций в час (pro тариф)
- 5 транскрипций в минуту (оба тарифа)

**Глобальные лимиты**:
- 1000 запросов в минуту к /api/transcribe
- Защита от DDoS через Cloudflare

---

## 💡 Будущие улучшения (после MVP)

### Функции Фазы 2 (Месяцы 3-6)

**Социальная аутентификация**:
- Вход через Google
- Вход через GitHub
- Вход через Apple

**Облачная синхронизация**:
- Опциональное облачное резервное копирование истории
- Синхронизация между устройствами (Mac + Windows)
- Разрешение конфликтов

**Продвинутые функции**:
- Пользовательские инструкции для каждого приложения
- Диаризация спикеров (определение говорящих)
- Временные метки в транскрипте
- Экспорт в различные форматы (txt, md, docx)

**Командные тарифы**:
- Организационные аккаунты
- Командный биллинг
- Аналитика использования по членам команды
- Общая история (опционально)

### Функции Фазы 3 (Месяцы 6-12)

**Мобильные приложения**:
- iOS приложение
- Android приложение
- Синхронизация с desktop

**API для разработчиков**:
- Публичное API для интеграций
- Webhooks для событий
- Документация API

**Маркетинг**:
- Полный лендинг
- Блог
- Отзывы клиентов
- Страницы сравнения

**Продвинутая аналитика**:
- Инсайты использования для пользователей
- Метрики продуктивности
- Наиболее транскрибируемые приложения

---

## 📋 Открытые вопросы

Перед началом разработки уточнить:

1. **Брендинг**:
   - Есть ли логотип Balentio Voice?
   - Hex-коды цветовой палитры?
   - Выбор шрифтов?

2. **ElevenLabs**:
   - Какой тарифный план ElevenLabs API? (Starter, Creator, Pro?)
   - Готов ли API ключ?
   - Лимиты на нашем плане?

3. **Бизнес**:
   - Кто обрабатывает email поддержки клиентов?
   - Политика возвратов?
   - Готовы ли Условия использования и Политика конфиденциальности?

4. **Технические**:
   - Готово ли доменное имя? (api.balentiovoice.com)
   - SSL сертификаты?
   - Сертификаты подписи кода для macOS/Windows?

---

## 🔗 Ресурсы и ссылки

### Конкурентное исследование
- [Aqua Voice](https://aquavoice.com/) - Основной референс
- [Aqua Voice на Product Hunt](https://www.producthunt.com/products/aqua)
- [Otter.ai](https://otter.ai/) - Лидер рынка
- [Deepgram AI Apps](https://deepgram.com/ai-apps/aqua-voice)

### Техническая документация
- [Whispering GitHub](https://github.com/EpicenterHQ/epicenter) - Оригинальная кодовая база
- [Документация ElevenLabs API](https://elevenlabs.io/docs)
- [Документация Supabase](https://supabase.com/docs)
- [Документация Stripe](https://stripe.com/docs)
- [Hono Framework](https://hono.dev/)
- [Документация Tauri](https://tauri.app/v2/)
- [Drizzle ORM](https://orm.drizzle.team/)

### Инструменты и сервисы
- [Railway](https://railway.app/) - Хостинг backend
- [Cloudflare](https://cloudflare.com/) - CDN и безопасность
- [GitHub Actions](https://github.com/features/actions) - CI/CD

---

## ✅ Критерии завершения (MVP)

MVP считается завершённым когда:

**Пользователь может**:
- [ ] Зарегистрироваться и войти с email/паролем
- [ ] Записывать аудио через горячую клавишу во всей системе
- [ ] Видеть живую волну во время записи
- [ ] Получать автоматически вставленный транскрибированный текст
- [ ] Просматривать историю транскрипций локально
- [ ] Видеть счётчик использования слов (X / 1500 слов)
- [ ] Блокироваться на 1500 словах (бесплатный тариф)
- [ ] Обновляться до Pro через Stripe Checkout
- [ ] Использовать неограниченную транскрипцию как Pro пользователь
- [ ] Отменять подписку со страницы аккаунта

**Технически**:
- [ ] Backend развёрнут на Railway (продакшн)
- [ ] Миграции БД выполнены успешно
- [ ] Webhooks Stripe обрабатываются корректно
- [ ] JWT аутентификация работает с refresh токенами
- [ ] macOS приложение подписано и нотаризовано
- [ ] Windows приложение подписано
- [ ] Автообновление настроено и протестировано
- [ ] Логирование ошибок и мониторинг активны

**Бизнес**:
- [ ] Минимум 5 бета-пользователей активно тестируют
- [ ] Минимум 2 платящие Pro подписки
- [ ] Все критические ошибки исправлены
- [ ] Условия использования и Политика конфиденциальности опубликованы
- [ ] Настроен email поддержки (support@balentiovoice.com)

---

## 📅 Сводка по срокам

| Фаза | Длительность | Ключевая веха |
|------|--------------|---------------|
| **Фаза 1: Основа** | 2 недели | Скелет backend API + БД |
| **Фаза 2: Основное API** | 1 неделя | Работающий эндпоинт транскрипции |
| **Фаза 3: Stripe** | 1 неделя | Интегрирован биллинг |
| **Фаза 4: Desktop Auth** | 1 неделя | Работающий Вход/Регистрация |
| **Фаза 5: Desktop Транскрипция** | 1 неделя | Сквозной процесс транскрипции |
| **Фаза 6: UI/UX** | 1 неделя | Отполированный интерфейс |
| **Фаза 7: Тестирование и запуск** | 1 неделя | Готово к продакшну |

**Всего: 8 недель до запуска MVP**

Дата начала: TBD
Целевой запуск: TBD + 8 недель

---

## 🚦 Следующие шаги

**Немедленные действия**:

1. [ ] Проверить и утвердить этот PRD
2. [ ] Настроить проект Supabase
3. [ ] Создать аккаунт Stripe (тестовый режим)
4. [ ] Получить API ключ ElevenLabs
5. [ ] Зарегистрировать домен (balentiovoice.com, api.balentiovoice.com)
6. [ ] Создать папку `apps/api` в репозитории
7. [ ] Начать Фазу 1: Основа Backend

**Вопросы?** Проверьте этот документ и подтвердите все технические решения перед началом разработки.

---

**Версия документа**: 2.0 (Финальная)
**Последнее обновление**: 2026-01-12
**Статус**: ✅ Готово к разработке

Давайте создадим Balentio Voice! 🚀
